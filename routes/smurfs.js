"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function steamIDToSteamID64(e){var t=(0,_big2.default)("76561197960265728"),r=e.split(":"),n=_slicedToArray(r,3),a=n[1],i=n[2];return t.plus((0,_big2.default)(i).times(2)).plus(a).valueOf()}function getSummaries(e){var t=this,r=e.join(),n="http://api.steampowered.com/ISteamUser/GetPlayerSummaries/v0002/?key="+APIKey+"&steamids="+r;return new Promise(function(e,r){(0,_request2.default)(n,function(n,a,i){var o=[];if(n)r(n);else if(!n&&200===a.statusCode){var u=JSON.parse(i),s=u.response.players;s.forEach(function(e){var t=e.personaname,r=e.steamid,n=e.profileurl,a=e.avatar,i=e.loccountrycode;if(3===e.communityvisibilitystate){var u=e.timecreated;o.push(new Player(r,t,i,(!0),n,a,u))}else o.push(new Player(r,t,i,(!1),n,a))},t)}e(o)})})}function checkVAC(e,t){var r=this,n=e.join(),a="http://api.steampowered.com/ISteamUser/GetPlayerBans/v1/?key="+APIKey+"&steamids="+n;return new Promise(function(e,n){(0,_request2.default)(a,function(a,i,o){a?n(a):a||200!==i.statusCode||!function(){var n=JSON.parse(o).players,a=t.map(function(e){var t=e;return n.forEach(function(e){t.steamID64===e.SteamId&&(t.VACBanned=e.VACBanned)},r),t});e(a)}()})})}function getStats(e,t){var r=e,n=t.playerstats.stats,a=n.filter(function(e){return"total_kills_headshot"===e.name}),i=_slicedToArray(a,1),o=i[0].value,u=n.filter(function(e){return"total_kills"===e.name}),s=_slicedToArray(u,1),l=s[0].value,f=n.filter(function(e){return"total_shots_hit"===e.name}),c=_slicedToArray(f,1),d=c[0].value,m=n.filter(function(e){return"total_shots_fired"===e.name}),h=_slicedToArray(m,1),p=h[0].value,_=n.filter(function(e){return"total_matches_won"===e.name}),v=_slicedToArray(_,1),y=v[0].value,A=n.filter(function(e){return"total_matches_played"===e.name}),g=_slicedToArray(A,1),P=g[0].value,S=n.filter(function(e){return"total_deaths"===e.name}),I=_slicedToArray(S,1),b=I[0].value;return r.kdr=(0,_big2.default)(l/b).round(2).valueOf(),r.hsp=(0,_big2.default)(o/l).times(100).round(2).valueOf()+"%",r.acc=(0,_big2.default)(d/p).times(100).round(2).valueOf()+"%",r.winrate=(0,_big2.default)(y/P).times(100).round(2).valueOf()+"%",r}function getPlaytime(e,t){var r=e,n=t.response.games.filter(function(e){return 730===e.appid}),a=_slicedToArray(n,1),i=a[0],o=i.playtime_2weeks,u=i.playtime_forever;return r.recentPlaytime=(0,_big2.default)(o).div(60).round(2).valueOf(),r.totalPlaytime=(0,_big2.default)(u).div(60).round(2).valueOf(),r}function getFriends(e,t){var r=e;return r.friends=t.friendslist.friends,r}function apiCall(e,t){var r=function(e){var r=e;return new Promise(function(e,n){if(r.publicProfile){var a=void 0;"stats"===t?a="http://api.steampowered.com/ISteamUserStats/GetUserStatsForGame/v0002/?appid=730&key="+APIKey+"&steamid="+r.steamID64:"playtime"===t?a="http://api.steampowered.com/IPlayerService/GetRecentlyPlayedGames/v0001/?key="+APIKey+"&steamid="+r.steamID64+"&format=json":"friends"===t&&(a="http://api.steampowered.com/ISteamUser/GetFriendList/v0001/?key="+APIKey+"&steamid="+r.steamID64+"&relationship=friend"),(0,_request2.default)(a,function(a,i,o){if(a)n(a);else if(!a&&200===i.statusCode){var u=void 0;"stats"===t?u=getStats(r,JSON.parse(o)):"playtime"===t?u=getPlaytime(r,JSON.parse(o)):"friends"===t&&(u=getFriends(r,JSON.parse(o))),e(u)}})}else e(r)})},n=e.map(r),a=Promise.all(n);return a}function checkFriends(e){var t=this,r=[];return e.forEach(function(n){n.publicProfile&&n.friends.forEach(function(a){e.forEach(function(e){if(e.steamID64===a.steamid){var i=_moment2.default.unix(a.friend_since).toNow(!0);r.length||r.push([e.handle,n.handle,i]);var o=!1;r.forEach(function(t){t.indexOf(e.handle)!==-1&&t.indexOf(n.handle)!==-1&&(o=!0)},t),o||r.push([e.handle,n.handle,i])}},t)},t)},this),r}function scrape(){var e=this;return new Promise(function(t){readStatus().then(function(t){var r=[];t.split("\n").forEach(function(e){e.match(/(#)( ).*?(STEAM)(_)(\d+)(:)(\d+)(:)(\d+)/)&&r.push(e.match(/STEAM_\d+:\d+:\d+/)[0])},e);var n=[];return r.forEach(function(e){n.push(steamIDToSteamID64(e))},e),n}).then(function(e){return getSummaries(e).then(function(t){return checkVAC(e,t)})}).then(function(e){return apiCall(e,"stats").then(function(e){return e})}).then(function(e){return apiCall(e,"playtime").then(function(e){return e})}).then(function(e){return apiCall(e,"friends").then(function(e){return e})}).then(function(r){var n=[{Avatar:"avatar"},{Handle:"handle"},{Country:"country"},{"Account age":"accountAge"},{"Recent playtime (hours)":"recentPlaytime"},{"Total playtime (hours)":"totalPlaytime"},{KDR:"kdr"},{HSP:"hsp"},{Accuracy:"acc"},{"Win Rate":"winrate"},{VAC:"VACBanned"}],a="| ";n.forEach(function(e){a+=Object.keys(e)[0]+" | "},e),a+="\n| ";for(var i=0;i<n.length;i++)a+="--- | ";a+="\n| ",r.forEach(function(t){n.forEach(function(e){var r=Object.keys(e),n=_slicedToArray(r,1),i=n[0],o=t[e[i]];a+=null===o||void 0===o?"- | ":o+" | "},e),a+="\n"},e),a+="\n";var o=checkFriends(r);o.forEach(function(e){var t=_slicedToArray(e,3),r=t[0],n=t[1],i=t[2];a+=r+" has been friends with "+n+" for "+i+"\n\n"},e),t(a)})})}Object.defineProperty(exports,"__esModule",{value:!0});var _slicedToArray=function(){function e(e,t){var r=[],n=!0,a=!1,i=void 0;try{for(var o,u=e[Symbol.iterator]();!(n=(o=u.next()).done)&&(r.push(o.value),!t||r.length!==t);n=!0);}catch(e){a=!0,i=e}finally{try{!n&&u.return&&u.return()}finally{if(a)throw i}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();exports.scrape=scrape;var _fs=require("fs"),_fs2=_interopRequireDefault(_fs),_request=require("request"),_request2=_interopRequireDefault(_request),_big=require("big.js"),_big2=_interopRequireDefault(_big),_moment=require("moment"),_moment2=_interopRequireDefault(_moment),_config=require("../config.js"),_config2=_interopRequireDefault(_config),readStatus=function(){return new Promise(function(e,t){_fs2.default.readFile("status.md","utf8",function(r,n){r?t(r):e(n)})})};process.env.STEAM_API_KEY=_config2.default;var APIKey=process.env.STEAM_API_KEY,Player=function e(t,r,n,a,i,o){var u=arguments.length<=6||void 0===arguments[6]?null:arguments[6];_classCallCheck(this,e),this.steamID64=t,this.handle="["+r+"]("+i+")",this.country=n,this.publicProfile=a,this.profileURL=i,this.avatar="!["+r+"]("+o+")",u?this.accountAge=_moment2.default.unix(u).from(this,!0):this.accountAge=u};